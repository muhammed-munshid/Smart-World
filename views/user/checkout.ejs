<!DOCTYPE html>
<html lang="zxx">

<%- include('../partials/user-header')%>

    <body>
        <!-- Page Preloder -->
        <!-- <div id="preloder">
        <div class="loader"></div>
    </div> -->

        <!-- Header Section Begin -->
        <%- include('../partials/head')%>
            <!-- Header Section End -->

            <!-- Breadcrumb Section Begin -->
            <section class="breadcrumb-option">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="breadcrumb__text">
                                <h4>Check Out</h4>
                                <div class="breadcrumb__links">
                                    <a href="/">Home</a>
                                    <a href="/cart">Cart</a>
                                    <span>Check Out</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Breadcrumb Section End -->

            <!-- Checkout Section Begin -->
            <section class="checkout spad">
                <div class="container">
                    <div class="checkout__form">
                        <form action="" id="checkout-form">
                            <div class="row">
                                <div class="col-lg-8 col-md-6">
                                    <a href="/add-address" class="btn btn-primary address mb-4">Add Address</a>
                                    <h6 class="checkout__title">Billing Details</h6>
                                    <% address.forEach(function(profile){%>
                                        <div class="card mb-5">
                                            <div class="card-body">
                                                <div class="col-sm-11 col-11"></div>
                                                <div class="">
                                                    <label for="payment">
                                                        <input type="radio" checked name="address" value="<%= profile._id %>" id="payment">
                                                    </label>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">First Name</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.First_Name %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Last Name</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.Last_Name %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Address</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.Address %> <br> <%= profile.Address2 %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Town/City</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.Town %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">State</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.State %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Country</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.Country %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Pincode</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.Pincode %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Phone</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.Mobile %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Email</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.Email %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Order notes</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary" style="font-size: 16px;">
                                                        <%= profile.Notes %>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <% }) %>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="checkout__order">
                                        <h4 class="order__title">Your order</h4>
                                        <div class="checkout__order__products">Product <span>Total</span></div>
                                        <ul class="checkout__total__products">
                                            <% let items=carts.items %>
                                                <% items.forEach(function(cart){%>
                                                    <li>
                                                        <%=cart.productName%><span>₹<%=cart.productPrice%></span>
                                                    </li>
                                                    <% }) %>
                                        </ul>
                                        <ul class="checkout__total__all">
                                            <li>Subtotal <span>₹<%=carts.total%></span></li>
                                            <li>Discount <span>₹<%= carts.discount.amount %> </span></li>
                                            <% if (carts.discount.amount>0) { %> 
                                            <li>Total <span>₹<%=carts.grandTotal%></span></li>
                                            <% } else { %> 
                                            <li>Total <span>₹<%=carts.total%></span></li>
                                            <% } %> 
                                        </ul>
                                        <div class="">
                                            <label for="payment">
                                                <input type="radio" name="payment-method" value="online" id="payment">
                                                Online payment
                                                <!-- <span class="checkmark"></span> -->
                                            </label>
                                        </div>
                                        <div class="">
                                            <label for="paypal">
                                                <input type="radio" name="payment-method" value="COD" id="cash">
                                                Cash on delivery
                                                <!-- <span class="checkmark"></span> -->
                                            </label>
                                        </div>
                                        <button type="submit" class="site-btn">PLACE
                                            ORDER</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
            <!-- Checkout Section End -->

            <!-- Js Plugins -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
            <script>
                $('#checkout-form').submit((e) => {
                    e.preventDefault()
                    $.ajax({
                        url: '/checkout',
                        method: 'post',
                        data: $('#checkout-form').serialize(),
                        success: async (response) => {
                            if (response.status) {
                                Swal.fire({
                                    position: "center",
                                    icon: "success",
                                    title: "Your order sucessfully",
                                    customClass: "swal-wide",
                                    showConfirmButton: false,
                                });
                                window.location.href = '/order-success'
                            } else {
                                if (response.order == null) {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Connection Failed',
                                        text: 'Please Check the Internet Connection!',
                                        customClass: 'swal-wide',
                                    })
                                } else {
                                    razorpayPayment(response)
                                }
                            }
                        }
                    })
                })

                function razorpayPayment(payment) {
                    
                    let options = {
                        "key": "rzp_test_WMLYqfRmARx3mG", // Enter the Key ID generated from the Dashboard
                        "amount": payment.order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                        "currency": "INR",
                        "name": "Smart World ",
                        "description": "Complete Your Transaction",
                        "image": "",
                        "order_id": payment.order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                        "handler": function (response) {
                            verifyPayment(response, payment)
                        },
                        "prefill": {
                            "name": payment.user.Name,
                            "email": payment.user.Email,
                            "contact": payment.user.Mobile
                        },
                        "notes": {
                            "address": "Home electron Choose your electric Best for Home"
                        },
                        "theme": {
                            "color": "#3399cc"
                        }
                    };
                    let rzp1 = new Razorpay(options);
                    rzp1.open();
                }
                function verifyPayment(payment,order) {
                    $.ajax({
                        url:'/verify-payment',
                        data:{
                            payment,
                            order
                        },
                        method:'post',
                        success:(response)=>{
                            if (response.status) {
                                Swal.fire({
                                    position: "center",
                                    icon: "success",
                                    title: "Your payment successfully",
                                    customClass: "swal-wide",
                                    showConfirmButton: false,
                                });
                                window.location.href = '/order-success'
                            } else {
                                alert('payment failed')
                                Swal.fire({
                                    position: "center",
                                    icon: "success",
                                    title: "Your payment failed",
                                    customClass: "swal-wide",
                                    showConfirmButton: false,
                                });
                                window.location.href = '/order-failed'
                            }
                        }
                    })
                }
            </script>
            <script>
                async function discountCode(couponId) {
                    alert('ok')
                    $.ajax({
                        url: `/coupon-code/${couponId}`,
                        method: "get",
                        success: (response) => {
                            if (response.deleted) {
                                Swal.fire({
                                    position: "center",
                                    icon: "success",
                                    title: "All Products are Deleted!",
                                    customClass: "swal-wide",
                                    showConfirmButton: false
                                });
                            }
                        }
                    })
                }
            </script>
            <%- include('../partials/user-footer')%>
    </body>

</html>